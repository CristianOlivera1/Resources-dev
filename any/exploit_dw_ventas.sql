-- D.1 - ROLL-UP:
-- Consulta D.1: Total de ventas por AÑO y REGIÓN
SELECT 
    dt.anio AS año,
    dr.continente,
    dr.nombre_region AS region,
    COUNT(DISTINCT cv.id_venta) AS num_ventas,
    SUM(cv.cantidad) AS unidades_vendidas,
    ROUND(SUM(cv.monto_venta), 2) AS ventas_totales,
    ROUND(SUM(cv.costo_total), 2) AS costos_totales,
    ROUND(SUM(cv.ganancia), 2) AS ganancia_total,
    ROUND(AVG(cv.margen_porcentaje), 2) AS margen_promedio_pct
FROM cubo_ventas_global cv
INNER JOIN dim_tiempo dt ON cv.id_tiempo = dt.id_tiempo
INNER JOIN dim_region dr ON cv.id_region = dr.id_region
GROUP BY dt.anio, dr.continente, dr.nombre_region
ORDER BY dt.anio, dr.continente, ventas_totales DESC;

-- Roll-Up adicional: Solo por AÑO (nivel más agregado)
SELECT 
    dt.anio AS año,
    COUNT(DISTINCT cv.id_venta) AS total_ventas_globales,
    SUM(cv.cantidad) AS total_unidades,
    ROUND(SUM(cv.monto_venta), 2) AS ventas_totales_globales,
    ROUND(SUM(cv.ganancia), 2) AS ganancia_total_global
FROM cubo_ventas_global cv
INNER JOIN dim_tiempo dt ON cv.id_tiempo = dt.id_tiempo
GROUP BY dt.anio
ORDER BY dt.anio;

-- Roll-Up adicional: Por AÑO y CONTINENTE (nivel intermedio)
SELECT 
    dt.anio AS año,
    dr.continente,
    COUNT(DISTINCT cv.id_venta) AS num_ventas,
    ROUND(SUM(cv.monto_venta), 2) AS ventas_totales,
    ROUND(SUM(cv.ganancia), 2) AS ganancia_total,
    -- Porcentaje sobre el total anual
    ROUND(
        SUM(cv.monto_venta) * 100.0 / 
        (SELECT SUM(monto_venta) FROM cubo_ventas_global cv2 
         INNER JOIN dim_tiempo dt2 ON cv2.id_tiempo = dt2.id_tiempo 
         WHERE dt2.anio = dt.anio),
        2
    ) AS porcentaje_del_año
FROM cubo_ventas_global cv
INNER JOIN dim_tiempo dt ON cv.id_tiempo = dt.id_tiempo
INNER JOIN dim_region dr ON cv.id_region = dr.id_region
GROUP BY dt.anio, dr.continente
ORDER BY dt.anio, ventas_totales DESC;

-- D.2 OPERACIÓN: DRILL-DOWN
-- Navegación desde nivel agregado a nivel más detallado

-- NIVEL 1: Ventas ANUALES (más agregado)
SELECT 
    dt.anio AS año,
    COUNT(DISTINCT cv.id_venta) AS num_ventas,
    ROUND(SUM(cv.monto_venta), 2) AS ventas_totales,
    ROUND(SUM(cv.ganancia), 2) AS ganancia_total
FROM cubo_ventas_global cv
INNER JOIN dim_tiempo dt ON cv.id_tiempo = dt.id_tiempo
GROUP BY dt.anio
ORDER BY dt.anio;

-- NIVEL 2: Drill-Down a MENSUALES (más detalle)
SELECT 
    dt.anio AS año,
    dt.mes,
    dt.nombre_mes,
    dt.trimestre,
    COUNT(DISTINCT cv.id_venta) AS num_ventas,
    SUM(cv.cantidad) AS unidades_vendidas,
    ROUND(SUM(cv.monto_venta), 2) AS ventas_mensuales,
    ROUND(SUM(cv.ganancia), 2) AS ganancia_mensual,
    ROUND(AVG(cv.monto_venta), 2) AS ticket_promedio
FROM cubo_ventas_global cv
INNER JOIN dim_tiempo dt ON cv.id_tiempo = dt.id_tiempo
GROUP BY dt.anio, dt.mes, dt.nombre_mes, dt.trimestre
ORDER BY dt.anio, dt.mes;

-- NIVEL 3: Drill-Down a REGIÓN/CIUDAD (máximo detalle)
-- Navegamos desde año → mes → región específica
SELECT 
    dt.anio AS año,
    dt.mes,
    dt.nombre_mes,
    dr.continente,
    dr.pais AS ciudad_pais,
    dr.nombre_region AS region,
    COUNT(DISTINCT cv.id_venta) AS num_ventas,
    SUM(cv.cantidad) AS unidades_vendidas,
    ROUND(SUM(cv.monto_venta), 2) AS ventas_totales,
    ROUND(SUM(cv.ganancia), 2) AS ganancia_total,
    ROUND(AVG(cv.monto_venta), 2) AS ticket_promedio
FROM cubo_ventas_global cv
INNER JOIN dim_tiempo dt ON cv.id_tiempo = dt.id_tiempo
INNER JOIN dim_region dr ON cv.id_region = dr.id_region
GROUP BY dt.anio, dt.mes, dt.nombre_mes, dr.continente, dr.pais, dr.nombre_region
ORDER BY dt.anio, dt.mes, dr.continente, ventas_totales DESC;

-- Drill-Down INTERACTIVO: Ejemplo de navegación paso a paso
-- Usuario ve año 2024 y quiere profundizar en Enero 2024 en Europa

-- Paso 1: Ver año completo
SELECT dt.anio, ROUND(SUM(cv.monto_venta), 2) AS ventas
FROM cubo_ventas_global cv
INNER JOIN dim_tiempo dt ON cv.id_tiempo = dt.id_tiempo
WHERE dt.anio = 2024
GROUP BY dt.anio;

-- Paso 2: Usuario hace clic en 2024, ve meses
SELECT dt.mes, dt.nombre_mes, ROUND(SUM(cv.monto_venta), 2) AS ventas
FROM cubo_ventas_global cv
INNER JOIN dim_tiempo dt ON cv.id_tiempo = dt.id_tiempo
WHERE dt.anio = 2024
GROUP BY dt.mes, dt.nombre_mes
ORDER BY dt.mes;

-- Paso 3: Usuario hace clic en Enero, ve regiones
SELECT dr.nombre_region, ROUND(SUM(cv.monto_venta), 2) AS ventas
FROM cubo_ventas_global cv
INNER JOIN dim_tiempo dt ON cv.id_tiempo = dt.id_tiempo
INNER JOIN dim_region dr ON cv.id_region = dr.id_region
WHERE dt.anio = 2024 AND dt.mes = 1
GROUP BY dr.nombre_region
ORDER BY ventas DESC;

-- Paso 4: Usuario hace clic en Europa Occidental, ve detalle diario
SELECT dt.fecha, dr.nombre_region, 
       ROUND(SUM(cv.monto_venta), 2) AS ventas
FROM cubo_ventas_global cv
INNER JOIN dim_tiempo dt ON cv.id_tiempo = dt.id_tiempo
INNER JOIN dim_region dr ON cv.id_region = dr.id_region
WHERE dt.anio = 2024 AND dt.mes = 1 AND dr.nombre_region = 'Europa Occidental'
GROUP BY dt.fecha, dr.nombre_region
ORDER BY dt.fecha;
/*
EXPLICACIÓN D.3 - SLICE:
Esto crea un "subcubo" con menos dimensiones para analizar.
*/

-- Primero, veamos qué segmentos de clientes existen
SELECT DISTINCT segmento_cliente 
FROM dim_cliente 
ORDER BY segmento_cliente;

-- Consulta D.3: Ventas del año 2024 solo para clientes VIP (Premium)
SELECT 
    dt.anio AS año,
    dt.nombre_mes AS mes,
    dc.segmento_cliente,
    dc.nombre_cliente,
    dr.continente,
    dr.nombre_region,
    COUNT(DISTINCT cv.id_venta) AS num_compras,
    SUM(cv.cantidad) AS unidades_compradas,
    ROUND(SUM(cv.monto_venta), 2) AS total_gastado,
    ROUND(AVG(cv.monto_venta), 2) AS ticket_promedio,
    ROUND(SUM(cv.ganancia), 2) AS ganancia_generada
FROM cubo_ventas_global cv
INNER JOIN dim_tiempo dt ON cv.id_tiempo = dt.id_tiempo
INNER JOIN dim_cliente dc ON cv.id_cliente = dc.id_cliente
INNER JOIN dim_region dr ON cv.id_region = dr.id_region
WHERE dt.anio = 2024                    -- SLICE: Solo año 2024
  AND dc.segmento_cliente = 'Premium'   -- SLICE: Solo clientes VIP/Premium
GROUP BY dt.anio, dt.mes, dt.nombre_mes, dc.segmento_cliente, 
         dc.nombre_cliente, dr.continente, dr.nombre_region
ORDER BY total_gastado DESC;

-- Análisis agregado de clientes Premium en 2024
SELECT 
    dt.anio AS año,
    dc.segmento_cliente,
    COUNT(DISTINCT dc.id_cliente) AS num_clientes_premium,
    COUNT(DISTINCT cv.id_venta) AS total_compras,
    SUM(cv.cantidad) AS total_unidades,
    ROUND(SUM(cv.monto_venta), 2) AS ventas_totales_premium,
    ROUND(AVG(cv.monto_venta), 2) AS ticket_promedio,
    ROUND(SUM(cv.ganancia), 2) AS ganancia_de_premium,
    -- Porcentaje sobre el total del año
    ROUND(
        SUM(cv.monto_venta) * 100.0 / 
        (SELECT SUM(monto_venta) FROM cubo_ventas_global cv2 
         INNER JOIN dim_tiempo dt2 ON cv2.id_tiempo = dt2.id_tiempo 
         WHERE dt2.anio = 2024),
        2
    ) AS porcentaje_ventas_año
FROM cubo_ventas_global cv
INNER JOIN dim_tiempo dt ON cv.id_tiempo = dt.id_tiempo
INNER JOIN dim_cliente dc ON cv.id_cliente = dc.id_cliente
WHERE dt.anio = 2024 
  AND dc.segmento_cliente = 'Premium'
GROUP BY dt.anio, dc.segmento_cliente;

-- Comparación Premium vs otros segmentos en 2024
SELECT 
    dt.anio AS año,
    dc.segmento_cliente,
    COUNT(DISTINCT dc.id_cliente) AS num_clientes,
    COUNT(DISTINCT cv.id_venta) AS num_compras,
    ROUND(SUM(cv.monto_venta), 2) AS ventas_totales,
    ROUND(AVG(cv.monto_venta), 2) AS ticket_promedio,
    ROUND(SUM(cv.ganancia), 2) AS ganancia_total
FROM cubo_ventas_global cv
INNER JOIN dim_tiempo dt ON cv.id_tiempo = dt.id_tiempo
INNER JOIN dim_cliente dc ON cv.id_cliente = dc.id_cliente
WHERE dt.anio = 2024
GROUP BY dt.anio, dc.segmento_cliente
ORDER BY ventas_totales DESC;
